<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Saya - Aplikasi Kontrak</title>
    <link rel="stylesheet" href="css/profil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body>
    <header class="top-header">
        <div class="logo-container">
            <img src="assets/logo-pelindo.png" alt="Logo Pelindo">
        </div>
        <div class="search-container">
            <input type="text" placeholder="Cari Kontrak">
            <i class="fa-solid fa-filter filter-icon"></i>
        </div>
    </header>
    <div class="main-container">
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fa-solid fa-grip"></i> Beranda</a></li>
                <li><a href="dokumen_all.html"><i class="fa-solid fa-file-lines"></i> Dokumen</a></li>
                <li><a href="notifikasi.html"><i class="fa-solid fa-bell"></i> Notifikasi</a></li>
                <li><a href="riwayat.html"><i class="fa-solid fa-clock-rotate-left"></i> Riwayat</a></li>
                <li><a href="profil.html" class="active"><i class="fa-solid fa-gear active"></i> Pengaturan</a></li>
            </ul>

            <div class="sidebar-profile">
                <img class="profile-img" src="assets/profile-picture.jpg" alt="Foto Profil">
                <a href="profil.html" class="profile-link">
                    <span class="profile-name">User</span>
                </a>
                <small class="profile-title">Tim Internal</small>
                <button onclick="window.auth.logout()" style="background: none; border: none; color: #fff; cursor: pointer; font-size: 12px; margin-top: 5px;">
                    <i class="fa-solid fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>
        <main class="main-content">
            <div class="profile-page-header">
                <div class="header-text">
                    <div class="header-title">
                        <i class="fa-solid fa-user"></i>
                        <h2>Profil Saya</h2>
                    </div>
                    <span id="currentDate">Loading...</span>
                </div>
            </div>

            <div class="profile-identity">
                <img src="assets/profile-picture.jpg" alt="Foto Profil" id="profileImage">
                <div class="identity-text">
                    <h3 id="profileName">Loading...</h3>
                    <p id="profileEmail">Loading...</p>
                </div>
                <button class="btn-edit" onclick="toggleEditMode()">Ubah</button>
            </div>

            <div class="profile-details" id="profileDetails">
                <div class="info-group">
                    <label>Nama Lengkap</label>
                    <div class="info-box" id="fullName">Loading...</div>
                </div>
                <div class="info-group">
                    <label>Email</label>
                    <div class="info-box" id="email">Loading...</div>
                </div>
                <div class="info-group">
                    <label>Role/Jabatan</label>
                    <div class="info-box" id="role">Loading...</div>
                </div>
                <div class="info-group">
                    <label>Instansi</label>
                    <div class="info-box" id="company">PT Pelindo</div>
                </div>
                <div class="info-group">
                    <label>Lokasi</label>
                    <div class="info-box" id="location">Jakarta, Indonesia</div>
                </div>
                <div class="info-group">
                    <label>Status</label>
                    <div class="info-box" id="status">Aktif</div>
                </div>
            </div>

            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button class="btn-cancel" onclick="cancelEdit()">Batal</button>
                <button class="btn-save" onclick="saveProfile()">Simpan</button>
            </div>
        </main>
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/ui.js"></script>
    <script>
        let isEditMode = false;
        let originalData = {};

        // Initialize profile page
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            updateCurrentDate();
        });

        async function loadProfile() {
            try {
                const userInfo = window.auth.getUserInfo();
                if (!userInfo) {
                    window.auth.redirectToLogin();
                    return;
                }

                // Update sidebar profile info
                window.ui.updateUserProfile();

                // Update main profile section
                document.getElementById('profileName').textContent = userInfo.name || 'Pengguna';
                document.getElementById('profileEmail').textContent = userInfo.email;

                // Update profile details
                document.getElementById('fullName').textContent = userInfo.name || 'Belum diatur';
                document.getElementById('email').textContent = userInfo.email;

                const roleMap = {
                    'internal': 'Tim Internal',
                    'legal': 'Tim Hukum',
                    'management': 'Tim Manajemen'
                };
                document.getElementById('role').textContent = roleMap[userInfo.role] || userInfo.role;

                // Store original data for cancel functionality
                originalData = {
                    name: userInfo.name || '',
                    email: userInfo.email,
                    role: roleMap[userInfo.role] || userInfo.role
                };

            } catch (error) {
                console.error('Failed to load profile:', error);
                window.ui.displayError('Gagal memuat profil');
            }
        }

        function updateCurrentDate() {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            const currentDate = new Date().toLocaleDateString('id-ID', options);
            document.getElementById('currentDate').textContent = currentDate;
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const profileDetails = document.getElementById('profileDetails');
            const actionButtons = document.getElementById('actionButtons');
            const editButton = document.querySelector('.btn-edit');

            if (isEditMode) {
                // Enter edit mode
                profileDetails.classList.add('edit-mode');
                actionButtons.style.display = 'flex';
                editButton.style.display = 'none';

                // Make fields editable
                makeFieldEditable('fullName');

            } else {
                // Exit edit mode
                profileDetails.classList.remove('edit-mode');
                actionButtons.style.display = 'none';
                editButton.style.display = 'flex';

                // Restore original values
                cancelEdit();
            }
        }

        function makeFieldEditable(fieldId) {
            const field = document.getElementById(fieldId);
            const currentValue = field.textContent;

            if (fieldId === 'fullName') {
                field.innerHTML = `<input type="text" value="${currentValue}" style="width: 100%; background: none; border: none; outline: none; font-size: inherit; color: inherit;">`;
            }
        }

        function cancelEdit() {
            // Restore original data
            document.getElementById('fullName').textContent = originalData.name || 'Belum diatur';

            // Exit edit mode
            if (isEditMode) {
                toggleEditMode();
            }
        }

        async function saveProfile() {
            try {
                const nameInput = document.querySelector('#fullName input');
                const newName = nameInput ? nameInput.value.trim() : originalData.name;

                if (!newName) {
                    window.ui.displayError('Nama tidak boleh kosong');
                    return;
                }

                // Show loading
                const saveBtn = document.querySelector('.btn-save');
                const originalText = saveBtn.innerHTML;
                window.ui.showLoading(saveBtn);

                // Here you would call the API to update profile
                // For now, just simulate success
                setTimeout(() => {
                    // Update the display
                    document.getElementById('fullName').textContent = newName;
                    document.getElementById('profileName').textContent = newName;

                    // Update original data
                    originalData.name = newName;

                    // Exit edit mode
                    toggleEditMode();

                    window.ui.displaySuccess('Profil berhasil diperbarui');
                    window.ui.hideLoading(saveBtn, originalText);
                }, 1000);

            } catch (error) {
                console.error('Failed to save profile:', error);
                window.ui.displayError('Gagal menyimpan profil');
            }
        }

        // Add click handlers for info boxes in edit mode
        document.addEventListener('click', (e) => {
            if (isEditMode && e.target.classList.contains('info-box') && e.target.id === 'fullName') {
                e.target.focus();
            }
        });
    </script>
</body>

</html>